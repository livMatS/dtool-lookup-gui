name: build-on-windows

on:
  push:
    # branches:
    #  - master
  pull_request:

# adapted template from https://www.msys2.org/docs/ci/
jobs:

  build:

    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: checkout
            uses: actions/checkout@v2
            with:
              fetch-depth: 0

      # strategy: aim at installing as many dependencies as possible from official mingw64 repo
      - name: Set up MINGW64 environment
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            curl
            git
            mingw-w64-x86_64-cc
            mingw-w64-x86_64-cython
            mingw-w64-x86_64-python-aiohttp
            mingw-w64-x86_64-python-asgiref
            mingw-w64-x86_64-python-boto3
            mingw-w64-x86_64-python-cairo
            mingw-w64-x86_64-python-click
            mingw-w64-x86_64-python-jsonschema
            mingw-w64-x86_64-python-numpy
            mingw-w64-x86_64-python-pip-tools
            mingw-w64-x86_64-python-requests
            mingw-w64-x86_64-python-ruamel-yaml
            mingw-w64-x86_64-python-ruamel.yaml.clib
            mingw-w64-x86_64-python-scipy
            mingw-w64-x86_64-python-setuptools
            mingw-w64-x86_64-python-setuptools-scm
            mingw-w64-x86_64-python-urllib3
            mingw-w64-x86_64-python-yaml

    # strategy: only install remaining pythonic dependencies via pip
    - name: Install pip
      run: |
        curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
        python get-pip.py
        # (ignore any error from previous step)
        python -m pip install -U --force-reinstall pip

    - name: Install remaining pythonic dependencies
      run: |
        pip install --upgrade pip
        pip install wheel
        pip install -r pyinstaller/mingw64_venv_pip_freeze_local.txt
        pip install pyinstaller

    - name: Compile gschemas
      run: |
        glib-compile-schemas .
      working-directory: dtool_lookup_gui

    - name: Package executable with pyinstaller
      run: |
        pyinstaller -y ./pyinstaller/dtool-lookup-gui-windows-one-file.spec

    - name: Upload artifact
      uses: actions/upload-artifact@v2
      with:
        name: dtool-lookup-gui.exe
        path: dist/dtool-lookup-gui.exe
        if-no-files-found: error
